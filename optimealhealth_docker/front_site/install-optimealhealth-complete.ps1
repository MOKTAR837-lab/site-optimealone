# ========================================
# Installation Compl√®te OptimealHealth
# Cr√©e TOUS les fichiers n√©cessaires
# ========================================

$ErrorActionPreference = "Stop"

Write-Host "`n‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó" -ForegroundColor Cyan
Write-Host "‚ïë   Installation OptimealHealth - S√©curit√© RGPD        ‚ïë" -ForegroundColor Cyan
Write-Host "‚ïë   Tous les fichiers seront cr√©√©s automatiquement     ‚ïë" -ForegroundColor Cyan
Write-Host "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù`n" -ForegroundColor Cyan

# V√©rification du r√©pertoire
$currentPath = Get-Location
Write-Host "üìÅ R√©pertoire actuel: $currentPath" -ForegroundColor Gray

if (-not (Test-Path "backend")) {
    Write-Host "‚ùå Le dossier 'backend' n'existe pas" -ForegroundColor Red
    Write-Host "‚ö†Ô∏è  Veuillez ex√©cuter ce script depuis:" -ForegroundColor Yellow
    Write-Host "   C:\site_optimealhealth.com\optimealhealth_docker\front_site" -ForegroundColor Yellow
    Read-Host "`nAppuyez sur Entr√©e pour quitter"
    exit 1
}

Write-Host "‚úì Dossier backend trouv√©" -ForegroundColor Green

# ========================================
# √âTAPE 1/10 : G√©n√©ration des cl√©s
# ========================================

Write-Host "`n[1/10] G√©n√©ration des cl√©s de s√©curit√©..." -ForegroundColor Yellow

# Cl√© JWT
$secretKey = -join ((65..90) + (97..122) + (48..57) | Get-Random -Count 32 | ForEach-Object {[char]$_})
$secretKey = [Convert]::ToBase64String([System.Text.Encoding]::UTF8.GetBytes($secretKey))

# Cl√© AES-256
$aesKey = New-Object byte[] 32
[System.Security.Cryptography.RNGCryptoServiceProvider]::new().GetBytes($aesKey)
$encryptionKey = [Convert]::ToBase64String($aesKey)

# Mot de passe PostgreSQL fort
$postgresPassword = -join ((65..90) + (97..122) + (48..57) + 33,35,36,37,38,42 | Get-Random -Count 20 | ForEach-Object {[char]$_})

Write-Host "   ‚úì SECRET_KEY g√©n√©r√©" -ForegroundColor Green
Write-Host "   ‚úì ENCRYPTION_KEY g√©n√©r√©" -ForegroundColor Green
Write-Host "   ‚úì Mot de passe PostgreSQL g√©n√©r√©" -ForegroundColor Green

# ========================================
# √âTAPE 2/10 : Cr√©ation structure dossiers
# ========================================

Write-Host "`n[2/10] Cr√©ation de la structure..." -ForegroundColor Yellow

$folders = @(
    "backend/app/core",
    "backend/app/models",
    "backend/app/routers",
    "backend/app/db",
    "frontend/components",
    "frontend/pages",
    "frontend/services",
    "frontend/styles",
    "logs"
)

foreach ($folder in $folders) {
    if (-not (Test-Path $folder)) {
        New-Item -ItemType Directory -Path $folder -Force | Out-Null
        Write-Host "   ‚úì $folder" -ForegroundColor Gray
    }
}

Write-Host "   ‚úì Structure cr√©√©e" -ForegroundColor Green

# ========================================
# √âTAPE 3/10 : Fichier .env
# ========================================

Write-Host "`n[3/10] Cr√©ation du fichier .env..." -ForegroundColor Yellow

$envContent = @"
# ========================================
# Configuration Base de donn√©es
# ========================================
POSTGRES_USER=postgres
POSTGRES_PASSWORD=$postgresPassword
POSTGRES_DB=optimeal
POSTGRES_HOST=db
POSTGRES_PORT=5432

# ========================================
# S√©curit√© JWT
# ========================================
SECRET_KEY=$secretKey

# ========================================
# Chiffrement AES-256
# ========================================
ENCRYPTION_KEY=$encryptionKey

# ========================================
# Ollama (IA)
# ========================================
OLLAMA_URL=http://host.docker.internal:11434
EMBED_MODEL=nomic-embed-text

# ========================================
# Configuration Python
# ========================================
PYTHONUTF8=1
LANG=C.UTF-8
LC_ALL=C.UTF-8

# ========================================
# CORS
# ========================================
CORS_ORIGINS=http://localhost,http://localhost:3000,http://localhost:80

# ========================================
# Environnement
# ========================================
ENVIRONMENT=development
DEBUG=1
"@

Set-Content -Path ".env" -Value $envContent -Encoding UTF8
Write-Host "   ‚úì .env cr√©√© avec cl√©s s√©curis√©es" -ForegroundColor Green

# ========================================
# √âTAPE 4/10 : .gitignore
# ========================================

Write-Host "`n[4/10] Mise √† jour .gitignore..." -ForegroundColor Yellow

$gitignoreContent = @"
# Environnement
.env
.env.local
.env.*.local

# Python
__pycache__/
*.py[cod]
*`$py.class
*.so
.Python
venv/
env/
ENV/

# Base de donn√©es
*.db
*.sqlite
postgres_data/

# Logs
*.log
logs/

# IDE
.vscode/
.idea/
*.swp

# Backups
_backup_*/

# Node
node_modules/
.next/
out/
dist/
build/

# Docker
.dockerignore

# SSL
certbot/
"@

Set-Content -Path ".gitignore" -Value $gitignoreContent -Encoding UTF8
Write-Host "   ‚úì .gitignore mis √† jour" -ForegroundColor Green

# ========================================
# √âTAPE 5/10 : requirements.txt
# ========================================

Write-Host "`n[5/10] Cr√©ation backend/requirements.txt..." -ForegroundColor Yellow

$requirementsContent = @"
# FastAPI et serveur
fastapi==0.109.0
uvicorn[standard]==0.27.0
gunicorn==21.2.0

# Base de donn√©es
sqlalchemy[asyncio]==2.0.25
asyncpg==0.29.0
alembic==1.13.1

# S√©curit√©
passlib[bcrypt]==1.7.4
python-jose[cryptography]==3.3.0
cryptography==42.0.2
pydantic[email]==2.5.3
python-multipart==0.0.6

# Utilitaires
httpx==0.26.0
python-dotenv==1.0.0
pydantic-settings==2.1.0
email-validator==2.1.0
"@

Set-Content -Path "backend/requirements.txt" -Value $requirementsContent -Encoding UTF8
Write-Host "   ‚úì requirements.txt cr√©√©" -ForegroundColor Green

# ========================================
# √âTAPE 6/10 : Fichiers Backend Python
# ========================================

Write-Host "`n[6/10] Cr√©ation des fichiers Backend Python..." -ForegroundColor Yellow

# Le contenu des fichiers Python sera ajout√© dans la partie 2 du script
# Pour l'instant, on cr√©e juste les fichiers vides
$backendFiles = @(
    "backend/app/__init__.py",
    "backend/app/core/__init__.py",
    "backend/app/core/security.py",
    "backend/app/models/__init__.py",
    "backend/app/models/user.py",
    "backend/app/routers/__init__.py",
    "backend/app/routers/auth.py",
    "backend/app/routers/gdpr.py",
    "backend/app/routers/health_profile.py",
    "backend/app/db/__init__.py",
    "backend/app/db/session.py",
    "backend/app/db/base.py"
)

foreach ($file in $backendFiles) {
    if (-not (Test-Path $file)) {
        New-Item -ItemType File -Path $file -Force | Out-Null
    }
}

Write-Host "   ‚úì Fichiers Backend cr√©√©s (contenu ajout√© dans √©tape suivante)" -ForegroundColor Green

# ========================================
# √âTAPE 7/10 : docker-compose.yml
# ========================================

Write-Host "`n[7/10] Mise √† jour docker-compose.yml..." -ForegroundColor Yellow

# Sauvegarde l'ancien
if (Test-Path "docker-compose.yml") {
    Copy-Item "docker-compose.yml" "docker-compose.yml.backup_$(Get-Date -Format 'yyyyMMdd_HHmmss')" -Force
}

$dockerComposeContent = @"
services:
  db:
    image: pgvector/pgvector:pg16
    container_name: optimeal-postgres
    environment:
      POSTGRES_USER: `${POSTGRES_USER:-postgres}
      POSTGRES_PASSWORD: `${POSTGRES_PASSWORD:-postgres}
      POSTGRES_DB: `${POSTGRES_DB:-optimeal}
      TZ: Europe/Paris
      PGTZ: Europe/Paris
    volumes:
      - postgres_data:/var/lib/postgresql/data
    networks:
      - internal
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 5s
      timeout: 3s
      retries: 5

  api:
    build:
      context: ./backend
      dockerfile: dockerfile
    container_name: optimeal-api
    environment:
      POSTGRES_USER: `${POSTGRES_USER:-postgres}
      POSTGRES_PASSWORD: `${POSTGRES_PASSWORD:-postgres}
      POSTGRES_DB: `${POSTGRES_DB:-optimeal}
      POSTGRES_HOST: db
      POSTGRES_PORT: 5432
      SECRET_KEY: `${SECRET_KEY}
      ENCRYPTION_KEY: `${ENCRYPTION_KEY}
      OLLAMA_URL: `${OLLAMA_URL:-http://host.docker.internal:11434}
      EMBED_MODEL: `${EMBED_MODEL:-nomic-embed-text}
      PYTHONUTF8: "1"
      LANG: C.UTF-8
      LC_ALL: C.UTF-8
      CORS_ORIGINS: `${CORS_ORIGINS:-http://localhost}
      ENVIRONMENT: `${ENVIRONMENT:-development}
      DEBUG: `${DEBUG:-1}
    depends_on:
      db:
        condition: service_healthy
    networks:
      - internal
    expose:
      - "8000"
    command: uvicorn app.main:app --host 0.0.0.0 --port 8000 --reload
    volumes:
      - ./backend:/app
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "python -c 'import urllib.request; urllib.request.urlopen(\"http://localhost:8000/health\")' || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 30s

  proxy:
    image: nginx:alpine
    container_name: optimeal-proxy
    depends_on:
      api:
        condition: service_healthy
    ports:
      - "80:80"
    volumes:
      - ./dist:/usr/share/nginx/html:ro
      - ./nginx.conf:/etc/nginx/conf.d/default.conf:ro
    networks:
      - internal
    restart: unless-stopped

volumes:
  postgres_data:

networks:
  internal:
    driver: bridge
"@

Set-Content -Path "docker-compose.yml" -Value $dockerComposeContent -Encoding UTF8
Write-Host "   ‚úì docker-compose.yml mis √† jour" -ForegroundColor Green

# ========================================
# √âTAPE 8/10 : nginx.conf
# ========================================

Write-Host "`n[8/10] Mise √† jour nginx.conf..." -ForegroundColor Yellow

$nginxContent = @"
server {
    listen 80;
    server_name localhost;
    client_max_body_size 10M;

    # Headers de s√©curit√©
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;

    # API Backend
    location /api/ {
        proxy_pass http://api:8000/api/;
        proxy_http_version 1.1;
        proxy_set_header Host `$host;
        proxy_set_header X-Real-IP `$remote_addr;
        proxy_set_header X-Forwarded-For `$proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto `$scheme;
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
        proxy_buffering off;
    }

    # Frontend
    location / {
        root /usr/share/nginx/html;
        try_files `$uri `$uri/ /index.html;
    }

    # Health check
    location /health {
        access_log off;
        return 200 "healthy\n";
        add_header Content-Type text/plain;
    }
}
"@

Set-Content -Path "nginx.conf" -Value $nginxContent -Encoding UTF8
Write-Host "   ‚úì nginx.conf mis √† jour" -ForegroundColor Green

# ========================================
# √âTAPE 9/10 : Informations finales
# ========================================

Write-Host "`n[9/10] Pr√©paration des informations..." -ForegroundColor Yellow

# Cr√©ation d'un fichier README
$readmeContent = @"
# OptimealHealth - Installation R√©ussie

## üîê Informations de S√©curit√©

### Cl√©s g√©n√©r√©es (NE PAS PARTAGER)
- SECRET_KEY: Stock√©e dans .env
- ENCRYPTION_KEY: Stock√©e dans .env  
- PostgreSQL Password: Stock√©e dans .env

‚ö†Ô∏è Ces cl√©s sont dans le fichier .env qui est ignor√© par Git.

## üöÄ Prochaines √âtapes

1. Copier le contenu des fichiers Python depuis les artifacts Claude
2. Lancer Docker: ``docker compose up -d --build``
3. Tester l'API: http://localhost/api/docs

## üìÅ Fichiers cr√©√©s

- .env (cl√©s de s√©curit√©)
- docker-compose.yml
- nginx.conf
- backend/requirements.txt
- Structure compl√®te des dossiers

## üìö Documentation

Voir README-SECURITE.md pour plus d'informations.

---
G√©n√©r√© le: $(Get-Date -Format "yyyy-MM-dd HH:mm:ss")
"@

Set-Content -Path "README-INSTALL.md" -Value $readmeContent -Encoding UTF8
Write-Host "   ‚úì README-INSTALL.md cr√©√©" -ForegroundColor Green

# ========================================
# √âTAPE 10/10 : R√©sum√©
# ========================================

Write-Host "`n[10/10] Installation termin√©e!" -ForegroundColor Yellow

Write-Host "`n‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó" -ForegroundColor Green
Write-Host "‚ïë          ‚úì INSTALLATION R√âUSSIE                       ‚ïë" -ForegroundColor Green
Write-Host "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù`n" -ForegroundColor Green

Write-Host "üìÅ Fichiers cr√©√©s:" -ForegroundColor Cyan
Write-Host "   ‚úì .env (cl√©s s√©curis√©es)" -ForegroundColor White
Write-Host "   ‚úì .gitignore" -ForegroundColor White
Write-Host "   ‚úì docker-compose.yml" -ForegroundColor White
Write-Host "   ‚úì nginx.conf" -ForegroundColor White
Write-Host "   ‚úì backend/requirements.txt" -ForegroundColor White
Write-Host "   ‚úì Structure de dossiers compl√®te" -ForegroundColor White

Write-Host "`nüìã PROCHAINES √âTAPES IMPORTANTES:" -ForegroundColor Yellow
Write-Host "`n1Ô∏è‚É£  Copier les fichiers Python" -ForegroundColor Cyan
Write-Host "   Ouvre une nouvelle conversation avec Claude et demande:" -ForegroundColor Gray
Write-Host "   'Donne-moi le contenu des fichiers Python pour OptimealHealth'" -ForegroundColor Gray

Write-Host "`n2Ô∏è‚É£  Ou utilise ce script pour t√©l√©charger les fichiers:" -ForegroundColor Cyan
Write-Host "   .\download-python-files.ps1" -ForegroundColor Gray
Write-Host "   (Script qui sera cr√©√© dans 5 secondes...)" -ForegroundColor Gray

Write-Host "`n3Ô∏è‚É£  Lancer Docker:" -ForegroundColor Cyan
Write-Host "   docker compose down" -ForegroundColor Gray
Write-Host "   docker compose build --no-cache" -ForegroundColor Gray
Write-Host "   docker compose up -d" -ForegroundColor Gray

Write-Host "`n4Ô∏è‚É£  Tester l'API:" -ForegroundColor Cyan
Write-Host "   http://localhost/api/docs" -ForegroundColor Gray

Write-Host "`nüîê S√©curit√©:" -ForegroundColor Yellow
Write-Host "   ‚Ä¢ Toutes les cl√©s sont dans .env (prot√©g√© par .gitignore)" -ForegroundColor White
Write-Host "   ‚Ä¢ NE JAMAIS commiter .env sur Git!" -ForegroundColor Red

Write-Host "`nüìÑ Documentation:" -ForegroundColor Cyan
Write-Host "   ‚Ä¢ README-INSTALL.md (ce qui a √©t√© fait)" -ForegroundColor White
Write-Host "   ‚Ä¢ .env (configuration)" -ForegroundColor White

Write-Host "`n‚ú® Tu peux maintenant cr√©er les fichiers Python!" -ForegroundColor Green
Write-Host ""

# Pause pour lire
Read-Host "`nAppuie sur Entr√©e pour continuer et cr√©er le script de t√©l√©chargement des fichiers Python"

# ========================================
# Cr√©ation script t√©l√©chargement Python
# ========================================

Write-Host "`nCr√©ation du script de t√©l√©chargement..." -ForegroundColor Yellow

$downloadScript = @"
# Script pour t√©l√©charger et cr√©er les fichiers Python
Write-Host "Ce script va te guider pour cr√©er les fichiers Python" -ForegroundColor Cyan
Write-Host "Ouvre les artifacts Claude et copie le contenu de chaque fichier`n" -ForegroundColor Gray

`$files = @(
    @{Path="backend/app/core/security.py"; Name="security.py (Chiffrement + JWT)"},
    @{Path="backend/app/models/user.py"; Name="user.py (Mod√®les BDD)"},
    @{Path="backend/app/routers/auth.py"; Name="auth.py (Authentification)"},
    @{Path="backend/app/routers/gdpr.py"; Name="gdpr.py (Routes RGPD)"},
    @{Path="backend/app/routers/health_profile.py"; Name="health_profile.py (Profil sant√©)"}
)

foreach (`$file in `$files) {
    Write-Host "Cr√©ation de: `$(`$file.Name)" -ForegroundColor Yellow
    notepad `$file.Path
    `$confirm = Read-Host "Fichier cr√©√©? (o/n)"
    if (`$confirm -ne "o") {
        Write-Host "Script interrompu" -ForegroundColor Red
        exit
    }
}

Write-Host "`n‚úì Tous les fichiers Python cr√©√©s!" -ForegroundColor Green
Write-Host "Lance maintenant: docker compose build --no-cache" -ForegroundColor Cyan
"@

Set-Content -Path "download-python-files.ps1" -Value $downloadScript -Encoding UTF8
Write-Host "‚úì Script cr√©√©: download-python-files.ps1`n" -ForegroundColor Green

Write-Host "Veux-tu lancer le script maintenant? (o/n): " -NoNewline -ForegroundColor Cyan
$response = Read-Host

if ($response -eq "o") {
    & ".\download-python-files.ps1"
}

Write-Host "`nüéâ Installation termin√©e! Bonne chance!" -ForegroundColor Green